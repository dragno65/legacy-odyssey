const { Router } = require('express');
const stripeService = require('../../services/stripeService');
const requireAuth = require('../../middleware/requireAuth');

const router = Router();

// POST /api/stripe/create-checkout
router.post('/create-checkout', async (req, res, next) => {
  try {
    const { email, domain, plan, period, subdomain: legacySubdomain } = req.body;

    // Support both new domain flow and legacy subdomain flow
    const subdomain = domain
      ? domain.split('.')[0].toLowerCase().replace(/[^a-z0-9-]/g, '')
      : legacySubdomain;

    if (!email || (!domain && !subdomain)) {
      return res.status(400).json({ error: 'email and domain (or subdomain) are required' });
    }

    // Validate plan and period
    const validPlans = ['starter', 'family', 'legacy'];
    const validPeriods = ['monthly', 'annual'];
    const resolvedPlan = validPlans.includes(plan) ? plan : 'starter';
    const resolvedPeriod = validPeriods.includes(period) ? period : 'monthly';

    const appDomain = process.env.APP_DOMAIN || 'legacyodyssey.com';
    const session = await stripeService.createCheckoutSession({
      email,
      subdomain,
      domain: domain || null,
      plan: resolvedPlan,
      period: resolvedPeriod,
      successUrl: `https://${appDomain}/stripe/success?session_id={CHECKOUT_SESSION_ID}`,
      cancelUrl: `https://${appDomain}/pricing`,
    });

    res.json({ url: session.url, sessionId: session.id });
  } catch (err) {
    next(err);
  }
});

// POST /api/stripe/portal â€” Billing management
router.post('/portal', requireAuth, async (req, res, next) => {
  try {
    if (!req.family.stripe_customer_id) {
      return res.status(400).json({ error: 'No Stripe customer found' });
    }

    const returnUrl = req.body.return_url || `https://${process.env.APP_DOMAIN || 'legacyodyssey.com'}`;
    const session = await stripeService.createPortalSession(
      req.family.stripe_customer_id,
      returnUrl
    );

    res.json({ url: session.url });
  } catch (err) {
    next(err);
  }
});

module.exports = router;
